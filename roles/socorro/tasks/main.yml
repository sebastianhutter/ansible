---

#
# install all the necessary socorro dependencies and setup a productive environment 
# as described in the official documentation
#


#
## setup the additional repositories
#

- name: install the postgresql repository
  yum: name=http://yum.pgrpms.org/9.4/redhat/rhel-6-{{ ansible_architecture }}/pgdg-centos94-9.4-1.noarch.rpm state=present
  when: ansible_os_family == "RedHat"
 
- name: add the elasticsearch gpg key for its repository
  rpm_key: state=present key=http://packages.elasticsearch.org/GPG-KEY-elasticsearch

- name: copy the elasticsearch repository config to the node
  copy: src=elasticsearch.repo dest=/etc/yum.repos.d/ backup=yes

# got the repo config file from here:
# http://people.centos.org/tru/devtools-1.1/readme
- name: copy the devtools repo configuration
  copy: src=devtools-1.1.repo dest=/etc/yum.repos.d/ backup=yes

#
## install the necessary pakacges
#

- name: install necessary packages
  yum: state=latest name={{ item }}
  with_items:
    - postgresql94-server
    - postgresql94-plperl
    - postgresql94-contrib
    - postgresql94-devel
    - make
    - rsync
    - gcc-c++
    - python-devel
    - python-pip
    - mercurial
    - libxml2-devel
    - libxslt-devel
    - java-1.7.0-openjdk
    - python-virtualenv
    - npm
    - devtoolset-1.1-gcc-c++
    - rabbitmq-server
    - elasticsearch
    - httpd
    - mod_wsgi
    - memcached
    - daemonize
    - mod_ssl
    - subversion
    - git

#
## configure rabbitmq
#

- name: (auto)start rabbitmq
  service: state=started enabled=yes name=rabbitmq-server 

#
## configure postgresql
#

- name: initiate postgresql database
  command: service postgresql-9.4 initdb 

- name: (auto)start postgresql service
  service: state=started enabled=yes name=postgresql-9.4

# will always trigger the handle restart postgresql because the regexp always stays true
# need to find a better way to solve this.
- name: replace the default postgresql timezone with UTC
  lineinfile: state=present dest=/var/lib/pgsql/9.4/data/postgresql.conf regexp='^timezone' line='timezone = ''UTC''' backup=yes
  notify: restart postgresql

#- name: to be safe restart the postgresql service
#  service: state=restarted name=postgresql-9.4 

#
## configure apache
#

      #### missing ####

#
## configure memcached
#
- name: (auto)start memchached
  service: state=started enabled=yes name=memcached

#
## setup the user account and the necessary directories
#
- name: create socorro service user
  user: name=socorro comment='service account for socorro' state=present

- name: create socorro directories 
  file: path={{ item.path }} state=directory owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }}
  with_items:
    - { path: '/etc/socorro', owner: 'root', group: 'root', mode: '0755' } 
    - { path: '/var/log/socorro', owner: 'socorro', group: 'socorro', mode: '0755' }
    - { path: '/data', owner: 'root', group: 'root', mode: '0755' }
    - { path: '/data/socorro', owner: 'socorro', group: 'root', mode: '0755' } 
    - { path: '/home/socorro/primaryCrashStore', owner: 'apache', group: 'root', mode: '2775' }
    - { path: '/home/socorro/fallback', owner: 'apache', group: 'root', mode: '2775' } 
    - { path: '/home/socorro/persistent', owner: 'root', group: 'root', mode: '0755' }
